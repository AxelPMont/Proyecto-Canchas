<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ partido.equipo_local }} vs {{ partido.equipo_visitante }} - En Vivo | Portal Deportivo Municipal</title>

    <!-- Meta tags para compartir en redes sociales -->
    <meta name="description"
        content="Transmisi√≥n en vivo del partido {{ partido.equipo_local }} vs {{ partido.equipo_visitante }} - Portal Deportivo Municipal de Jayanca">
    <meta property="og:title" content="{{ partido.equipo_local }} vs {{ partido.equipo_visitante }} - En Vivo">
    <meta property="og:description" content="Sigue el partido en vivo desde el Portal Deportivo Municipal">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/transmision.css') }}">

    <!-- Peque√±o estilo para que el logo ocupe el c√≠rculo -->
    <style>
        .overlay-logo-img {
            width: 100%;
            height: 100%;
            border-radius: 999px;
            object-fit: cover;
        }
    </style>
</head>

<body>

    <!-- NAVBAR -->
    <nav class="navbar-municipal">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <a href="{{ url_for('ws_partidos.pantalla_publica_partidos') }}" class="municipal-brand">
                    <div class="brand-icon">‚öΩ</div>
                    <div class="brand-text">
                        <div class="brand-title">Portal Deportivo Municipal</div>
                        <div class="brand-subtitle">Municipalidad Distrital de Jayanca</div>
                    </div>
                </a>

                <ul class="nav-links d-none d-md-flex">
                    <li>
                        <a href="{{ url_for('ws_partidos.pantalla_publica_partidos') }}" class="nav-link-item">
                            <i class="bi bi-house-fill"></i> Inicio
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link-item active">
                            <i class="bi bi-play-circle-fill"></i> En Vivo
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link-item">
                            <i class="bi bi-trophy-fill"></i> Torneos
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link-item">
                            <i class="bi bi-calendar-event-fill"></i> Calendario
                        </a>
                    </li>
                </ul>

                <button class="btn d-md-none" style="background: rgba(255,255,255,0.2); color: white; border: none;">
                    <i class="bi bi-list" style="font-size: 1.5rem;"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- LIVE STATUS -->
    {% if partido.estado == 'en_juego' or partido.estado_transmision == 'en_vivo' %}
    <div class="live-status-bar">
        <span class="live-dot"></span>
        TRANSMISI√ìN EN VIVO
    </div>
    {% endif %}

    <!-- MATCH HEADER -->
    <div class="match-header-section">
        <div class="container">
            <div class="match-info-container">

                <!-- Team Local -->
                <div class="team-section">
                    <div class="team-logo-container">
                        {% if partido.logo_local_url %}
                        {% set logo_local = partido.logo_local_url %}
                        {% if logo_local.startswith('http') %}
                        <img src="{{ logo_local }}" alt="{{ partido.equipo_local }}" class="team-logo-img">
                        {% elif logo_local.startswith('/') %}
                        <img src="{{ logo_local }}" alt="{{ partido.equipo_local }}" class="team-logo-img">
                        {% else %}
                        <img src="{{ url_for('static', filename='img/' ~ logo_local) }}"
                            alt="{{ partido.equipo_local }}" class="team-logo-img">
                        {% endif %}
                        {% else %}
                        <div class="team-logo-text">{{ partido.equipo_local[:2]|upper }}</div>
                        {% endif %}
                    </div>
                    <div class="team-info">
                        <div class="team-name">{{ partido.equipo_local }}</div>
                        <div class="team-details">
                            <span>{{ partido.division }}</span>
                            {% if partido.grupo %}
                            <span>Grupo {{ partido.grupo }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Score -->
                <div class="score-center">
                    <div class="score-display-large">
                        <span id="publicGolesLocal">{{ partido.goles_local or 0 }}</span>
                        <span class="score-separator">-</span>
                        <span id="publicGolesVisitante">{{ partido.goles_visitante or 0 }}</span>
                    </div>
                    <div class="match-status" id="badgeEstado">
                        {% if partido.estado == 'en_juego' %}
                        EN VIVO
                        {% elif partido.estado == 'finalizado' %}
                        FINALIZADO
                        {% else %}
                        PR√ìXIMAMENTE
                        {% endif %}
                    </div>
                    <div class="match-time-info" id="publicEstadoTexto">
                        {% if partido.texto_estado %}
                        {{ partido.texto_estado }}
                        {% else %}
                        {{ partido.fecha_hora }}
                        {% endif %}
                    </div>
                </div>

                <!-- Team Visitante -->
                <div class="team-section away">
                    <div class="team-logo-container">
                        {% if partido.logo_visitante_url %}
                        {% set logo_vis = partido.logo_visitante_url %}
                        {% if logo_vis.startswith('http') %}
                        <img src="{{ logo_vis }}" alt="{{ partido.equipo_visitante }}" class="team-logo-img">
                        {% elif logo_vis.startswith('/') %}
                        <img src="{{ logo_vis }}" alt="{{ partido.equipo_visitante }}" class="team-logo-img">
                        {% else %}
                        <img src="{{ url_for('static', filename='img/' ~ logo_vis) }}"
                            alt="{{ partido.equipo_visitante }}" class="team-logo-img">
                        {% endif %}
                        {% else %}
                        <div class="team-logo-text">{{ partido.equipo_visitante[:2]|upper }}</div>
                        {% endif %}
                    </div>
                    <div class="team-info">
                        <div class="team-name">{{ partido.equipo_visitante }}</div>
                        <div class="team-details">
                            <span>Torneo {{ partido.torneo }}</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <!-- TOURNAMENT BAR -->
    <div class="tournament-bar">
        <div class="container">
            <div class="tournament-info">
                <div class="tournament-item">
                    <i class="bi bi-calendar-check"></i>
                    <span>{{ partido.fecha_hora }}</span>
                </div>
                <div class="tournament-item">
                    <i class="bi bi-geo-alt-fill"></i>
                    <span>{{ partido.cancha }}</span>
                </div>
                <div class="tournament-item">
                    <i class="bi bi-trophy"></i>
                    <span>{{ partido.torneo }}</span>
                </div>
                {% if partido.jornada %}
                <div class="tournament-item">
                    <i class="bi bi-hash"></i>
                    <span>Jornada {{ partido.jornada }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- TABS -->
    <div class="tabs-section">
        <div class="container">
            <div class="tabs-container">
                <button class="tab-button active" data-tab="live">
                    <i class="bi bi-play-circle-fill"></i>
                    <span>En Vivo</span>
                </button>
                <button class="tab-button" data-tab="stats">
                    <i class="bi bi-bar-chart-fill"></i>
                    <span>Estad√≠sticas</span>
                </button>
                <button class="tab-button" data-tab="timeline">
                    <i class="bi bi-clock-history"></i>
                    <span>Eventos</span>
                </button>
                <button class="tab-button" data-tab="info">
                    <i class="bi bi-info-circle-fill"></i>
                    <span>Informaci√≥n</span>
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="content-container">
        <div class="content-grid">

            <!-- LEFT COLUMN -->
            <div>
                <!-- ========== TAB LIVE (EN VIVO) ========== -->
                <div id="tab-live" class="tab-pane active">
                    <!-- VIDEO SECTION -->
                    <div class="video-section">
                        <div class="video-header">
                            <div class="video-title">
                                <i class="bi bi-camera-video-fill"></i>
                                Transmisi√≥n en Vivo
                            </div>
                            <div class="video-controls">
                                <button class="video-control-btn" title="Pantalla completa">
                                    <i class="bi bi-arrows-fullscreen"></i>
                                </button>
                                <button class="video-control-btn" title="Compartir">
                                    <i class="bi bi-share-fill"></i>
                                </button>
                            </div>
                        </div>

                        <div class="video-wrapper">
                            {% if partido.url_publica %}
                            {% if partido.plataforma == 'Facebook' %}
                            <iframe
                                src="https://www.facebook.com/plugins/video.php?href={{ partido.url_publica|urlencode }}&show_text=0&autoplay=1"
                                scrolling="no" frameborder="0" allowfullscreen="true"
                                allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share">
                            </iframe>
                            {% elif partido.plataforma == 'Twitch' %}
                            {% set twitch_channel = partido.url_publica
                            | replace('https://www.twitch.tv/', '')
                            | replace('https://twitch.tv/', '')
                            | replace('/', '') %}
                            <iframe
                                src="https://player.twitch.tv/?channel={{ twitch_channel }}&parent={{ twitch_parent }}&parent=localhost&parent=127.0.0.1"
                                frameborder="0" allowfullscreen="true" scrolling="no" allow="autoplay; encrypted-media">
                            </iframe>
                            {% else %}
                            <iframe src="{{ partido.url_publica }}" frameborder="0" allowfullscreen
                                allow="autoplay; encrypted-media">
                            </iframe>
                            {% endif %}
                            {% else %}
                            <div class="video-placeholder">
                                <i class="bi bi-camera-video-off"></i>
                                <p>Transmisi√≥n no disponible</p>
                                <small>Este partido a√∫n no cuenta con transmisi√≥n configurada</small>
                            </div>
                            {% endif %}

                            <!-- OVERLAY SCOREBOARD (CON LOGOS) -->
                            <div class="video-overlay-scoreboard" id="scoreOverlayPublic">
                                <!-- Local -->
                                <div class="overlay-team">
                                    <div class="overlay-logo overlay-logo-local"
                                        style="background: linear-gradient(135deg, #4caf50, #2e7d32);">
                                        <img id="sbLocalLogo" class="overlay-logo-img" src=""
                                            alt="{{ partido.equipo_local }}" style="display:none;">
                                        <span id="sbLocalInitials">{{ partido.equipo_local[:2]|upper }}</span>
                                    </div>
                                    <div class="overlay-score" id="overlayGolesLocal">{{ partido.goles_local or 0 }}
                                    </div>
                                </div>

                                <!-- Estado -->
                                <div class="overlay-status" id="overlayEstadoPartido">
                                    {% if partido.estado == 'en_juego' %}
                                    EN VIVO
                                    {% elif partido.estado == 'finalizado' %}
                                    FINALIZADO
                                    {% else %}
                                    PROGRAMADO
                                    {% endif %}
                                </div>

                                <!-- Visitante -->
                                <div class="overlay-team">
                                    <div class="overlay-score" id="overlayGolesVisitante">{{ partido.goles_visitante or
                                        0 }}</div>
                                    <div class="overlay-logo overlay-logo-visit"
                                        style="background: linear-gradient(135deg, #2196f3, #0d47a1);">
                                        <img id="sbVisitLogo" class="overlay-logo-img" src=""
                                            alt="{{ partido.equipo_visitante }}" style="display:none;">
                                        <span id="sbVisitInitials">{{ partido.equipo_visitante[:2]|upper }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- EVENT BANNER -->
                            <div id="eventBanner" class="event-banner-overlay">
                                <div class="event-banner-content" id="eventBannerContent">
                                    <div class="event-icon-large" id="eventIcon">‚öΩ</div>
                                    <div class="event-text-container">
                                        <div class="event-main-text" id="eventMainText">¬°GOL!</div>
                                        <div class="event-sub-text" id="eventSubText">Equipo Local anota</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
<!-- =========================
     COMENTARIOS EN VIVO
     ========================= -->
<div class="comments-section mt-4">
    <div class="section-header">
        <div class="section-title">
            <i class="bi bi-chat-dots-fill"></i>
            Comentarios en vivo
        </div>
    </div>

    <form id="commentForm" class="comment-form">
        <div class="row g-2">
            <div class="col-md-3">
                <input type="text" id="commentName" class="form-control" placeholder="Tu nombre" maxlength="100" required>
            </div>
            <div class="col-md-7">
                <input type="text" id="commentText" class="form-control" placeholder="Escribe tu comentario..." maxlength="250" required>
            </div>
            <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-send-fill me-1"></i> Enviar
                </button>
            </div>
        </div>
    </form>

    <div id="commentsList" class="comments-list mt-3">
        <!-- Comentarios se insertan aqu√≠ por JS -->
    </div>
</div>

                    <!-- MUNICIPAL BANNER -->
                    <div class="municipal-banner">
                        <div class="municipal-banner-content">
                            <div class="municipal-title">Municipalidad Distrital de Jayanca</div>
                            <div class="municipal-subtitle">Promoviendo el deporte y la uni√≥n de nuestra comunidad</div>
                        </div>
                    </div>
                </div>

                <!-- ========== TAB TIMELINE (EVENTOS) ========== -->
                <div id="tab-timeline" class="tab-pane">
                    <div class="timeline-section">
                        <div class="section-header">
                            <div class="section-title">
                                <i class="bi bi-clock-history"></i>
                                L√≠nea de Tiempo del Partido
                            </div>
                            <span class="badge bg-danger">
                                <i class="bi bi-broadcast"></i> En Vivo
                            </span>
                        </div>
                        <div id="timelineEventos">
                            <div class="timeline-empty">
                                <i class="bi bi-hourglass-split"></i>
                                <p>Esperando eventos del partido...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== TAB STATS (ESTAD√çSTICAS) ========== -->
                <div id="tab-stats" class="tab-pane">
    <div class="stats-section">
        <div class="section-header">
            <div class="section-title">
                <i class="bi bi-bar-chart-fill"></i>
                Estad√≠sticas del Partido
            </div>
        </div>

        <!-- TIROS A PUERTA -->
        <div class="stat-row">
            <div class="stat-value stat-value-left" id="statShotsOnTargetLocal">0</div>
            <div class="stat-info">
                <div class="stat-label">Tiros a puerta</div>
                <div class="stat-bar-container">
                    <div class="stat-bar">
                        <div class="stat-bar-fill-left" id="barShotsOnTargetLeft" style="width: 0%;"></div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-bar-fill-right" id="barShotsOnTargetRight" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            <div class="stat-value stat-value-right" id="statShotsOnTargetVisit">0</div>
        </div>

        <!-- TIROS TOTALES -->
        <div class="stat-row">
            <div class="stat-value stat-value-left" id="statShotsTotalLocal">0</div>
            <div class="stat-info">
                <div class="stat-label">Tiros totales</div>
                <div class="stat-bar-container">
                    <div class="stat-bar">
                        <div class="stat-bar-fill-left" id="barShotsTotalLeft" style="width: 0%;"></div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-bar-fill-right" id="barShotsTotalRight" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            <div class="stat-value stat-value-right" id="statShotsTotalVisit">0</div>
        </div>

        <!-- TARJETAS AMARILLAS -->
        <div class="stat-row">
            <div class="stat-value stat-value-left" id="statYellowLocal">0</div>
            <div class="stat-info">
                <div class="stat-label">Tarjetas amarillas</div>
                <div class="stat-bar-container">
                    <div class="stat-bar">
                        <div class="stat-bar-fill-left" id="barYellowLeft" style="width: 0%;"></div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-bar-fill-right" id="barYellowRight" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            <div class="stat-value stat-value-right" id="statYellowVisit">0</div>
        </div>

        <!-- TIROS DE ESQUINA -->
        <div class="stat-row">
            <div class="stat-value stat-value-left" id="statCornersLocal">0</div>
            <div class="stat-info">
                <div class="stat-label">Tiros de esquina</div>
                <div class="stat-bar-container">
                    <div class="stat-bar">
                        <div class="stat-bar-fill-left" id="barCornersLeft" style="width: 0%;"></div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-bar-fill-right" id="barCornersRight" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            <div class="stat-value stat-value-right" id="statCornersVisit">0</div>
        </div>
    </div>
</div>

            </div>

            <!-- RIGHT SIDEBAR -->
            <div>
                <!-- MATCH INFO -->
                <div class="sidebar-section">
                    <div class="sidebar-title">
                        <i class="bi bi-info-circle-fill"></i>
                        Informaci√≥n del Partido
                    </div>

                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-geo-alt-fill"></i>
                            Estadio
                        </div>
                        <div class="info-value">{{ partido.cancha }}</div>
                    </div>

                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-trophy-fill"></i>
                            Torneo
                        </div>
                        <div class="info-value">{{ partido.torneo }}</div>
                    </div>

                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-layers-fill"></i>
                            Divisi√≥n
                        </div>
                        <div class="info-value">{{ partido.division }}</div>
                    </div>

                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-calendar-event"></i>
                            Fecha y hora
                        </div>
                        <div class="info-value">{{ partido.fecha_hora }}</div>
                    </div>

                    {% if partido.jornada %}
                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-hash"></i>
                            Jornada
                        </div>
                        <div class="info-value">{{ partido.jornada }}</div>
                    </div>
                    {% endif %}

                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-circle-fill"></i>
                            Estado
                        </div>
                        <div class="info-value">
                            {% if partido.estado == 'en_juego' %}
                            <span class="badge bg-success">En Juego</span>
                            {% elif partido.estado == 'finalizado' %}
                            <span class="badge bg-secondary">Finalizado</span>
                            {% else %}
                            <span class="badge bg-primary">Programado</span>
                            {% endif %}
                        </div>
                    </div>

                    {% if partido.plataforma %}
                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-broadcast"></i>
                            Plataforma
                        </div>
                        <div class="info-value">{{ partido.plataforma }}</div>
                    </div>
                    {% endif %}

                    {% if partido.url_publica %}
                    <div class="info-item">
                        <div class="info-label">
                            <i class="bi bi-link-45deg"></i>
                            Enlace
                        </div>
                        <div class="info-value">
                            <a href="{{ partido.url_publica }}" target="_blank"
                                style="color: var(--municipal-red); font-weight: 700;">
                                Ver en {{ partido.plataforma or 'plataforma' }}
                            </a>
                        </div>
                    </div>
                    {% endif %}

                    <!-- SHARE SECTION -->
                    <div class="share-section">
                        <div class="share-title">Compartir partido</div>
                        <div class="share-buttons">
                            <button class="share-btn facebook" title="Compartir en Facebook">
                                <i class="bi bi-facebook"></i>
                            </button>
                            <button class="share-btn twitter" title="Compartir en Twitter">
                                <i class="bi bi-twitter-x"></i>
                            </button>
                            <button class="share-btn whatsapp" title="Compartir en WhatsApp">
                                <i class="bi bi-whatsapp"></i>
                            </button>
                            <button class="share-btn link" title="Copiar enlace" id="copyLinkBtn">
                                <i class="bi bi-link-45deg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        
    </div>

    <!-- FOOTER -->
    <footer class="footer-section">
        <div class="footer-content">
            <div class="footer-grid">
                <div class="footer-column">
                    <h4>Portal Deportivo Municipal</h4>
                    <p>
                        La Municipalidad Distrital de Jayanca promueve el deporte como herramienta
                        de integraci√≥n social y desarrollo comunitario. Aqu√≠ podr√°s seguir todos
                        los eventos deportivos de nuestra localidad.
                    </p>
                </div>
                <div class="footer-column">
                    <h4>Enlaces R√°pidos</h4>
                    <ul class="footer-links">
                        <li><a href="#">Inicio</a></li>
                        <li><a href="#">Torneos</a></li>
                        <li><a href="#">Calendario</a></li>
                        <li><a href="#">Resultados</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Informaci√≥n</h4>
                    <ul class="footer-links">
                        <li><a href="#">T√©rminos y Condiciones</a></li>
                        <li><a href="#">Pol√≠tica de Privacidad</a></li>
                        <li><a href="#">Contacto</a></li>
                        <li><a href="#">Preguntas Frecuentes</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Contacto</h4>
                    <ul class="footer-links">
                        <li><i class="bi bi-geo-alt-fill"></i> Jayanca, Lambayeque</li>
                        <li><i class="bi bi-telephone-fill"></i> (074) XXX-XXX</li>
                        <li><i class="bi bi-envelope-fill"></i> deportes@jayanca.gob.pe</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Municipalidad Distrital de Jayanca. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // =========================
    // CONFIGURATION
    // =========================
    const CONFIG = {
        API_ESTADO: "{{ url_for('ws_partidos.api_estado_partido', partido_id=partido.id) }}",
        API_ULTIMO_EVENTO: "{{ url_for('ws_partidos.api_ultimo_evento', partido_id=partido.id) }}",
        API_EVENTOS: "{{ url_for('ws_partidos.api_eventos_partido', partido_id=partido.id) }}",
        EQUIPO_LOCAL: "{{ partido.equipo_local }}",
        EQUIPO_VISITANTE: "{{ partido.equipo_visitante }}",
        UPDATE_INTERVAL_SCORE: 5000,
        UPDATE_INTERVAL_EVENT: 4000,
        UPDATE_INTERVAL_TIMELINE: 8000,
        EVENT_DISPLAY_TIME: 5500
    };

    // Base para rutas de logos
    const BASE_LOGOS = "{{ url_for('static', filename='img') }}/";

    function buildLogoUrl(raw) {
        if (!raw) return null;
        if (raw.startsWith('http') || raw.startsWith('/')) {
            return raw;
        }
        return BASE_LOGOS + raw;
    }

    // =========================
    // STATE
    // =========================
    const state = {
        ultimoEventoId: null,
        timeoutEvento: null
    };

    // =========================
    // DOM ELEMENTS
    // =========================
    const elements = {
        // Scoreboard
        badgeEstado: document.getElementById('badgeEstado'),
        publicGolesLocal: document.getElementById('publicGolesLocal'),
        publicGolesVisitante: document.getElementById('publicGolesVisitante'),
        publicEstadoTexto: document.getElementById('publicEstadoTexto'),

        // Overlay
        scoreOverlay: document.getElementById('scoreOverlayPublic'),
        overlayGolesLocal: document.getElementById('overlayGolesLocal'),
        overlayGolesVisitante: document.getElementById('overlayGolesVisitante'),
        overlayEstadoPartido: document.getElementById('overlayEstadoPartido'),
        sbLocalLogo: document.getElementById('sbLocalLogo'),
        sbLocalInitials: document.getElementById('sbLocalInitials'),
        sbVisitLogo: document.getElementById('sbVisitLogo'),
        sbVisitInitials: document.getElementById('sbVisitInitials'),

        // Events
        eventBanner: document.getElementById('eventBanner'),
        eventBannerContent: document.getElementById('eventBannerContent'),
        eventIcon: document.getElementById('eventIcon'),
        eventMainText: document.getElementById('eventMainText'),
        eventSubText: document.getElementById('eventSubText'),

        // Timeline
        timelineEventos: document.getElementById('timelineEventos'),

        // Sidebar (para tab "Informaci√≥n")
        sidebarSection: document.querySelector('.sidebar-section'),

        // === STATS (tab estad√≠sticas) ===
        statShotsOnTargetLocal: document.getElementById('statShotsOnTargetLocal'),
        statShotsOnTargetVisit: document.getElementById('statShotsOnTargetVisit'),
        barShotsOnTargetLeft: document.getElementById('barShotsOnTargetLeft'),
        barShotsOnTargetRight: document.getElementById('barShotsOnTargetRight'),

        statShotsTotalLocal: document.getElementById('statShotsTotalLocal'),
        statShotsTotalVisit: document.getElementById('statShotsTotalVisit'),
        barShotsTotalLeft: document.getElementById('barShotsTotalLeft'),
        barShotsTotalRight: document.getElementById('barShotsTotalRight'),

        statYellowLocal: document.getElementById('statYellowLocal'),
        statYellowVisit: document.getElementById('statYellowVisit'),
        barYellowLeft: document.getElementById('barYellowLeft'),
        barYellowRight: document.getElementById('barYellowRight'),

        statCornersLocal: document.getElementById('statCornersLocal'),
        statCornersVisit: document.getElementById('statCornersVisit'),
        barCornersLeft: document.getElementById('barCornersLeft'),
        barCornersRight: document.getElementById('barCornersRight')
    };

    // =========================
    // PINTAR LOGOS EN EL SCOREBOARD
    // =========================
    function aplicarLogosScoreboard(data) {
        if (!elements.sbLocalLogo || !elements.sbVisitLogo) return;

        const logoLocalRaw = data.logo_local_url;
        const logoVisitRaw = data.logo_visitante_url;

        function setLogo(raw, img, span, side) {
            if (!img || !span) return;

            if (!raw) {
                img.style.display = 'none';
                span.style.display = 'block';
                return;
            }

            const src = buildLogoUrl(raw);

            img.onload = () => {
                console.log(`‚úÖ Logo ${side} cargado:`, src);
                span.style.display = 'none';
                img.style.display = 'block';
            };

            img.onerror = () => {
                console.error(`‚ùå Error cargando logo ${side}:`, src);
                img.style.display = 'none';
                span.style.display = 'block';
            };

            img.src = src;
        }

        setLogo(logoLocalRaw, elements.sbLocalLogo, elements.sbLocalInitials, 'LOCAL');
        setLogo(logoVisitRaw, elements.sbVisitLogo, elements.sbVisitInitials, 'VISITANTE');
    }

    // =========================
    // SCOREBOARD UPDATE
    // =========================
    async function actualizarMarcador() {
        try {
            const response = await fetch(CONFIG.API_ESTADO, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (!response.ok) return;

            const data = await response.json();

            const golesLocal = data.goles_local ?? data.golesLocal ?? 0;
            const golesVisitante = data.goles_visitante ?? data.golesVisitante ?? 0;
            const estado = (data.estado || '').toLowerCase();
            const textoEstado = data.texto_estado || data.textoEstado || '';
            const mostrarOverlay = data.mostrar_overlay ?? data.mostrarOverlay ?? true;

            // Update main scoreboard
            if (elements.publicGolesLocal) elements.publicGolesLocal.textContent = golesLocal;
            if (elements.publicGolesVisitante) elements.publicGolesVisitante.textContent = golesVisitante;

            // Update overlay
            if (elements.overlayGolesLocal) elements.overlayGolesLocal.textContent = golesLocal;
            if (elements.overlayGolesVisitante) elements.overlayGolesVisitante.textContent = golesVisitante;

            // Update status
            if (elements.overlayEstadoPartido) {
                if (textoEstado) {
                    elements.overlayEstadoPartido.textContent = textoEstado;
                } else {
                    elements.overlayEstadoPartido.textContent =
                        estado === 'en_juego' ? 'EN VIVO' :
                        estado === 'finalizado' ? 'FINALIZADO' : 'PROGRAMADO';
                }
            }

            // Show/hide overlay
            if (elements.scoreOverlay) {
                elements.scoreOverlay.style.display = mostrarOverlay ? 'flex' : 'none';
            }

            // Update badge
            if (elements.badgeEstado) {
                const badgeText =
                    estado === 'en_juego' ? 'EN VIVO' :
                    estado === 'finalizado' ? 'FINALIZADO' : 'PR√ìXIMAMENTE';
                elements.badgeEstado.textContent = badgeText;
            }

            // Update text
            if (elements.publicEstadoTexto) {
                elements.publicEstadoTexto.textContent = textoEstado ||
                    (estado === 'en_juego' ? 'Partido en juego' :
                        estado === 'finalizado' ? 'Finalizado' : '');
            }

        } catch (error) {
            console.error('Error actualizando marcador:', error);
        }
    }

    // =========================
    // EVENT MESSAGE BUILDER
    // =========================
    function construirMensajeEvento(evt) {
        const { tipo, equipo, jugador1, jugador2, minuto, texto_libre } = evt;
        const nombreEquipo = equipo === 'local' ? CONFIG.EQUIPO_LOCAL : CONFIG.EQUIPO_VISITANTE;

        let main = '';
        let sub = '';

        switch (tipo) {
            case 'gol':
                main = '¬°GOOOL!';
                sub = jugador1
                    ? `${jugador1} (${nombreEquipo})`
                    : `Gol de ${nombreEquipo}`;
                break;
            case 'penal':
                main = 'PENAL';
                sub = jugador1
                    ? `${nombreEquipo} - Ejecuta ${jugador1}`
                    : `Penal a favor de ${nombreEquipo}`;
                break;
            case 'offside':
            case 'fuera_de_juego':
                main = 'FUERA DE JUEGO';
                sub = jugador1
                    ? `${jugador1} (${nombreEquipo})`
                    : `Offside de ${nombreEquipo}`;
                break;
            case 'amarilla':
                main = 'TARJETA AMARILLA';
                sub = jugador1
                    ? `${jugador1} (${nombreEquipo})`
                    : `Amonestaci√≥n en ${nombreEquipo}`;
                break;
            case 'roja':
                main = 'TARJETA ROJA';
                sub = jugador1
                    ? `${jugador1} (${nombreEquipo})`
                    : `Expulsi√≥n en ${nombreEquipo}`;
                break;
            case 'cambio':
                main = 'CAMBIO';
                sub = jugador1 && jugador2
                    ? `Sale ${jugador1}, entra ${jugador2} (${nombreEquipo})`
                    : `Cambio en ${nombreEquipo}`;
                break;
            case 'tiro_puerta':
                main = 'TIRO A PUERTA';
                sub = jugador1
                    ? `Disparo de ${jugador1} (${nombreEquipo})`
                    : `Tiro a puerta de ${nombreEquipo}`;
                break;
            case 'tiro_esquina':
                main = 'TIRO DE ESQUINA';
                sub = jugador1
                    ? `Corner a favor de ${nombreEquipo} - ${jugador1}`
                    : `Tiro de esquina para ${nombreEquipo}`;
                break;
            default:
                main = 'EVENTO';
                sub = texto_libre || `Nuevo evento en ${nombreEquipo}`;
        }

        if (minuto) {
            sub += ` ‚Ä¢ ${minuto}'`;
        }

        return { main, sub, tipo, equipo, minuto };
    }

    // =========================
    // EVENT DISPLAY
    // =========================
    function getEventIcon(tipo) {
        const icons = {
            gol: '‚öΩ',
            penal: 'üéØ',
            offside: 'üß£',
            fuera_de_juego: 'üß£',
            amarilla: 'üü®',
            roja: 'üü•',
            cambio: 'üîÅ',
            tiro_puerta: 'üéØ',
            tiro_esquina: 'üö©'
        };
        return icons[tipo] || 'üì£';
    }

    function mostrarEventoBanner(evt) {
        if (!elements.eventBanner) return;

        // Clear previous timeout
        if (state.timeoutEvento) {
            clearTimeout(state.timeoutEvento);
            elements.eventBanner.classList.remove('show');
        }

        const { main, sub, tipo } = construirMensajeEvento(evt);
        const icono = getEventIcon(tipo);

        // Update content
        elements.eventIcon.textContent = icono;
        elements.eventMainText.textContent = main;
        elements.eventSubText.textContent = sub;

        // Apply type class
        elements.eventBannerContent.className = 'event-banner-content';
        if ([
            'gol',
            'penal',
            'amarilla',
            'roja',
            'cambio',
            'offside',
            'fuera_de_juego',
            'tiro_puerta',
            'tiro_esquina'
        ].includes(tipo)) {
            elements.eventBannerContent.classList.add(`tipo-${tipo}`);
        }

        // Show banner
        setTimeout(() => elements.eventBanner.classList.add('show'), 50);

        // Hide after delay
        state.timeoutEvento = setTimeout(() => {
            elements.eventBanner.classList.remove('show');
        }, CONFIG.EVENT_DISPLAY_TIME);
    }

    async function verificarNuevoEvento() {
        try {
            const response = await fetch(CONFIG.API_ULTIMO_EVENTO, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (!response.ok) return;

            const data = await response.json();

            // SIEMPRE aplicamos logos, aunque ok sea False
            aplicarLogosScoreboard(data);

            if (!data.ok || !data.evento) return;

            const evt = data.evento;

            if (!evt.evento_id || evt.evento_id === state.ultimoEventoId) return;

            state.ultimoEventoId = evt.evento_id;
            mostrarEventoBanner(evt);

        } catch (error) {
            console.error('Error verificando evento:', error);
        }
    }

    // =========================
    // STATS DESDE EVENTOS
    // =========================
    function setStatRow(local, visit, valueLocalEl, valueVisitEl, barLeftEl, barRightEl) {
        if (!valueLocalEl || !valueVisitEl || !barLeftEl || !barRightEl) return;

        valueLocalEl.textContent = local;
        valueVisitEl.textContent = visit;

        const total = local + visit;
        let leftPct = 0;
        let rightPct = 0;

        if (total > 0) {
            leftPct = (local / total) * 100;
            rightPct = (visit / total) * 100;
        }

        barLeftEl.style.width = leftPct + '%';
        barRightEl.style.width = rightPct + '%';
    }

    function updateStatsFromEvents(eventos) {
        // estructura base
        const base = () => ({
            tiros_puerta: 0,
            tiros_totales: 0,
            amarillas: 0,
            corners: 0
        });

        const local = base();
        const visit = base();

        if (eventos && eventos.length) {
            eventos.forEach(evt => {
                const tipo = evt.tipo;
                const equipo = evt.equipo;
                const target =
                    equipo === 'local' ? local :
                    equipo === 'visitante' ? visit : null;
                if (!target) return;

                switch (tipo) {
                    case 'tiro_puerta':
                        target.tiros_puerta++;
                        target.tiros_totales++; // tiro a puerta es tambi√©n un tiro total
                        break;
                    case 'gol':
                    case 'penal':
                        target.tiros_totales++;
                        break;
                    case 'tiro_esquina':
                        target.corners++;
                        target.tiros_totales++;
                        break;
                    case 'amarilla':
                        target.amarillas++;
                        break;
                    default:
                        break;
                }
            });
        }

        // Tiros a puerta
        setStatRow(
            local.tiros_puerta,
            visit.tiros_puerta,
            elements.statShotsOnTargetLocal,
            elements.statShotsOnTargetVisit,
            elements.barShotsOnTargetLeft,
            elements.barShotsOnTargetRight
        );

        // Tiros totales
        setStatRow(
            local.tiros_totales,
            visit.tiros_totales,
            elements.statShotsTotalLocal,
            elements.statShotsTotalVisit,
            elements.barShotsTotalLeft,
            elements.barShotsTotalRight
        );

        // Amarillas
        setStatRow(
            local.amarillas,
            visit.amarillas,
            elements.statYellowLocal,
            elements.statYellowVisit,
            elements.barYellowLeft,
            elements.barYellowRight
        );

        // Tiros de esquina
        setStatRow(
            local.corners,
            visit.corners,
            elements.statCornersLocal,
            elements.statCornersVisit,
            elements.barCornersLeft,
            elements.barCornersRight
        );
    }

    // =========================
    // TIMELINE
    // =========================
    function renderTimeline(eventos) {
        if (!elements.timelineEventos) return;

        if (!eventos || eventos.length === 0) {
            elements.timelineEventos.innerHTML = `
                <div class="timeline-empty">
                    <i class="bi bi-hourglass-split"></i>
                    <p>Esperando eventos del partido...</p>
                </div>
            `;
            // tambi√©n dejamos las stats en cero
            updateStatsFromEvents([]);
            return;
        }

        // Sort events
        eventos.sort((a, b) => {
            const minA = parseInt(a.minuto || '0', 10);
            const minB = parseInt(b.minuto || '0', 10);
            if (minA !== minB) return minA - minB;
            return (a.creado_en || '').localeCompare(b.creado_en || '');
        });

        let html = '<ul class="timeline-list">';

        eventos.forEach(evt => {
            const { main, sub, tipo, equipo, minuto } = construirMensajeEvento(evt);
            const minStr = minuto ? `${minuto}'` : '';
            const claseTipo = tipo ? `tipo-${tipo}` : 'tipo-otro';

            let badgeEquipo = '';
            if (equipo === 'local') {
                badgeEquipo = `<span class="timeline-badge local">${CONFIG.EQUIPO_LOCAL}</span>`;
            } else if (equipo === 'visitante') {
                badgeEquipo = `<span class="timeline-badge visitante">${CONFIG.EQUIPO_VISITANTE}</span>`;
            }

            html += `
                <li class="timeline-item ${claseTipo}">
                    <div class="timeline-minute">${minStr || '-'}</div>
                    <div class="timeline-content-text">
                        <div class="timeline-main-text">${main}${badgeEquipo}</div>
                        <div class="timeline-sub-text">${sub}</div>
                    </div>
                </li>
            `;
        });

        html += '</ul>';
        elements.timelineEventos.innerHTML = html;

        // üîÅ actualizar estad√≠sticas con los mismos eventos
        updateStatsFromEvents(eventos);
    }

    async function cargarTimeline() {
        try {
            const response = await fetch(CONFIG.API_EVENTOS, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (!response.ok) return;

            const data = await response.json();

            if (data.ok) {
                const eventos = data.eventos || [];
                renderTimeline(eventos);
            }
        } catch (error) {
            console.error('Error cargando timeline:', error);
        }
    }

    // =========================
    // TABS - CAMBIO DE CONTENIDO
    // =========================
    const tabPanes = {
        live: document.getElementById('tab-live'),
        stats: document.getElementById('tab-stats'),
        timeline: document.getElementById('tab-timeline')
    };

    document.querySelectorAll('.tab-button').forEach(tab => {
        tab.addEventListener('click', function () {
            const target = this.dataset.tab; // live, stats, timeline, info

            // Activar bot√≥n
            document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            // Mostrar/Ocultar panes principales (columna izquierda)
            Object.keys(tabPanes).forEach(key => {
                if (tabPanes[key]) {
                    if (key === target) {
                        tabPanes[key].classList.add('active');
                    } else {
                        tabPanes[key].classList.remove('active');
                    }
                }
            });

            // Tab "info": desplazarse y resaltar la secci√≥n de informaci√≥n (sidebar derecha)
            if (target === 'info' && elements.sidebarSection) {
                // Ocultar panes de la izquierda
                Object.keys(tabPanes).forEach(key => tabPanes[key]?.classList.remove('active'));

                elements.sidebarSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });

                elements.sidebarSection.classList.add('sidebar-highlight');
                setTimeout(() => {
                    elements.sidebarSection.classList.remove('sidebar-highlight');
                }, 1500);
            }
        });
    });

    // =========================
    // SHARE FUNCTIONALITY
    // =========================
    document.getElementById('copyLinkBtn')?.addEventListener('click', () => {
        navigator.clipboard.writeText(window.location.href).then(() => {
            alert('¬°Enlace copiado al portapapeles!');
        });
    });

    document.querySelector('.share-btn.facebook')?.addEventListener('click', () => {
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`, '_blank');
    });

    document.querySelector('.share-btn.whatsapp')?.addEventListener('click', () => {
        window.open(`https://wa.me/?text=${encodeURIComponent(window.location.href)}`, '_blank');
    });

    // =========================
    // INITIALIZATION
    // =========================
    function initialize() {
        console.log('üöÄ Inicializando portal p√∫blico...');

        // Logos iniciales desde el propio template (por si tarda la API)
        aplicarLogosScoreboard({
            logo_local_url: "{{ partido.logo_local_url or '' }}",
            logo_visitante_url: "{{ partido.logo_visitante_url or '' }}"
        });

        // Initial load
        actualizarMarcador();
        verificarNuevoEvento();
        cargarTimeline();

        // Set intervals
        setInterval(actualizarMarcador, CONFIG.UPDATE_INTERVAL_SCORE);
        setInterval(verificarNuevoEvento, CONFIG.UPDATE_INTERVAL_EVENT);
        setInterval(cargarTimeline, CONFIG.UPDATE_INTERVAL_TIMELINE);

        console.log('‚úÖ Portal p√∫blico listo');
    }

    // Start when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }
</script>

<script>
   const COMMENTS_CONFIG = {
    API_COMENTARIOS: "{{ url_for('ws_partidos.api_comentarios', partido_id=partido.id) }}",
    POLL_INTERVAL: 4000
};

const commentsState = {
    lastId: null,
    loading: false
};

const commentsElements = {
    form: document.getElementById('commentForm'),
    nameInput: document.getElementById('commentName'),
    textInput: document.getElementById('commentText'),
    list: document.getElementById('commentsList')
};

function formatTime(isoStr) {
    if (!isoStr) return '';
    const d = new Date(isoStr);
    if (Number.isNaN(d.getTime())) return '';
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function appendComment(c) {
    if (!commentsElements.list) return;

    const div = document.createElement('div');
    div.className = 'comment-item';

    const nameSpan = document.createElement('span');
    nameSpan.className = 'comment-name';
    nameSpan.textContent = c.nombre;

    const timeSpan = document.createElement('span');
    timeSpan.className = 'comment-time';
    timeSpan.textContent = formatTime(c.creado_en);

    const textSpan = document.createElement('span');
    textSpan.className = 'comment-text';
    textSpan.textContent = c.texto;

    div.appendChild(nameSpan);
    if (c.creado_en) div.appendChild(timeSpan);
    div.appendChild(textSpan);

    commentsElements.list.appendChild(div);
    commentsElements.list.scrollTop = commentsElements.list.scrollHeight;
}

async function loadInitialComments() {
    try {
        const resp = await fetch(COMMENTS_CONFIG.API_COMENTARIOS, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (!resp.ok) return;
        const data = await resp.json();
        if (!data.ok) return;

        commentsElements.list.innerHTML = '';
        (data.comentarios || []).forEach(c => {
            appendComment(c);
            commentsState.lastId = c.id;
        });
    } catch (e) {
        console.error('Error cargando comentarios:', e);
    }
}

async function pollNewComments() {
    if (commentsState.loading) return;
    commentsState.loading = true;

    try {
        let url = COMMENTS_CONFIG.API_COMENTARIOS;
        if (commentsState.lastId) {
            url += `?last_id=${commentsState.lastId}`;
        }

        const resp = await fetch(url, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (!resp.ok) {
            commentsState.loading = false;
            return;
        }

        const data = await resp.json();
        if (!data.ok) {
            commentsState.loading = false;
            return;
        }

        (data.comentarios || []).forEach(c => {
            appendComment(c);
            commentsState.lastId = c.id;
        });
    } catch (e) {
        console.error('Error en poll de comentarios:', e);
    } finally {
        commentsState.loading = false;
    }
}

async function sendComment(e) {
    e.preventDefault();

    const nombre = commentsElements.nameInput.value.trim();
    const texto = commentsElements.textInput.value.trim();

    if (!nombre || !texto) return;

    try {
        const resp = await fetch(COMMENTS_CONFIG.API_COMENTARIOS, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ nombre, texto })
        });

        const data = await resp.json();
        if (data.ok && data.comentario) {
            appendComment(data.comentario);
            commentsState.lastId = data.comentario.id;
            commentsElements.textInput.value = '';
        } else {
            console.error('Error al enviar comentario:', data);
        }
    } catch (e) {
        console.error('Error al enviar comentario:', e);
    }
}

function initComments() {
    if (!commentsElements.form) return;

    commentsElements.form.addEventListener('submit', sendComment);

    loadInitialComments();
    setInterval(pollNewComments, COMMENTS_CONFIG.POLL_INTERVAL);
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initComments);
} else {
    initComments();
}
</script>

</body>

</html>